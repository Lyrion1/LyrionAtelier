<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17836603744"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17836603744');
</script>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
 <title>Stripe Checkout</title>
  <link rel="stylesheet" href="/styles/design-system.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://js.stripe.com/v3/"></script>
 <style>
 body {
 font-family: Arial, sans-serif;
 max-width: 600px;
 margin: 100px auto;
 padding: 40px;
 background: #f5f5f5;
 }
  .product-card {
  background: white;
  padding: 40px;
 border-radius: 12px;
 box-shadow: 0 4px 12px rgba(0,0,0,0.1);
 }
 h1 {
 color: #1a1a1a;
 margin-bottom: 10px;
 }
 .price {
 font-size: 2rem;
 color: #28a745;
 margin: 20px 0;
 }
 button {
 width: 100%;
 padding: 16px;
 background: #1a1a1a;
 color: white;
 border: none;
 border-radius: 8px;
 font-size: 1.1rem;
 font-weight: 600;
 cursor: pointer;
 transition: background 0.3s;
 }
  button:hover {
  background: #000;
  }
  </style>
 </head>
 <body>
<header class="site-header" data-nav-version="nav-v4">
 <nav class="main-nav" aria-label="Main navigation">
 <a href="/" class="logo-link">
 <img src="/images/lyrion-logo.png" alt="Lyrīon Atelier" class="logo-img">
 <span class="brand-name">LYRĪON ATELIER</span>
 </a>
 
 <button class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation" aria-controls="primary-nav">☰</button>
 
 <div class="nav-links" id="primary-nav" aria-hidden="true">
 <a href="/">Home</a>
 <a href="/shop">Shop</a>
 <a href="/curated-for-gifting">Curated for Gifting</a>
 <a href="/oracle">Oracle</a>
 <a href="/compatibility">Compatibility</a>
 <a href="/codex">Codex</a>
 <a href="/contact">Contact</a>
 <a href="/cart" class="cart-icon">Cart <span class="cart-count" aria-live="polite" style="display:none;">0</span></a>
 </div>
 </nav>
</header>

 <div class="product-card">
 <h1>Lyrion Billionaire Bag</h1>
        <p class="price">$1.00</p>
 <button id="checkout-button">Checkout</button>
 </div>

 <script src="js/main.js" defer></script>
 <script>
   const checkoutButton = document.getElementById('checkout-button');
   const DEFAULT_PRICE_ID = 'price_1ShjdBE6FRwoxLBfyUvK1ark';
   let publishableKey;
   let stripeMode = 'test';
   const stripePromise = fetch('/.netlify/functions/get-stripe-key')
     .then(res => res.json())
     .then(data => {
       if (!data?.publishableKey) {
         throw new Error('Missing Stripe publishable key');
       }
       publishableKey = data.publishableKey;
       window.STRIPE_PUBLISHABLE_KEY = publishableKey;
       const isStripeKey = typeof publishableKey === 'string' && publishableKey.startsWith('pk_');
       stripeMode = isStripeKey && publishableKey.includes('_live_') ? 'live' : 'test';
       return Stripe(publishableKey);
     })
     .catch(err => {
       console.error('Failed to load Stripe key:', err);
       throw err;
     });
   
   checkoutButton.addEventListener('click', async () => {
     checkoutButton.textContent = 'Loading...';
     checkoutButton.disabled = true;

     try {
        const configuredPriceId = window?.STRIPE_PRICE_ID_LIVE || DEFAULT_PRICE_ID;
        const hasLivePriceId = Boolean(window?.STRIPE_PRICE_ID_LIVE);
        if (stripeMode === 'live' && !hasLivePriceId) {
          throw new Error('Stripe price ID is not configured for live mode.');
        }
        const stripe = await stripePromise;
        if (!stripe) {
          throw new Error('Stripe unavailable');
        }
        // Call backend to create checkout session
        const response = await fetch('/.netlify/functions/create-checkout', {
          method: 'POST',
           headers: {
             'Content-Type': 'application/json',
           },
           body: JSON.stringify({
            priceId: configuredPriceId,
            quantity: 1
          })
        });

       // Check if response is ok
       if (!response.ok) {
         const errorText = await response.text();
         throw new Error('Backend error: ' + errorText);
       }

        const data = await response.json();
        console.log('Backend response:', data); // Debug log

       // Check if sessionId exists
       if (!data.sessionId) {
         throw new Error('No sessionId received from backend');
       }

        const isStripeKey = typeof publishableKey === 'string' && publishableKey.startsWith('pk_');
        const keyMode = stripeMode || (isStripeKey && publishableKey.includes('_live_') ? 'live' : 'test');
        if (keyMode !== 'live') {
          console.error('WARNING: Stripe is not in live mode!');
        }
       
       // Redirect to checkout
       const { error } = await stripe.redirectToCheckout({ 
         sessionId: data.sessionId 
       });

       if (error) {
         throw new Error(error.message);
       }
      } catch (e) {
        console.error('Checkout error:', e); // Debug log
        alert('Error: ' + e.message);
        checkoutButton.textContent = 'Checkout';
        checkoutButton.disabled = false;
      }
    });
 </script>
</body>
</html>
