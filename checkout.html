<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Lyrion Atelier - Celestial Guidance & Astrology">
  <meta property="og:description" content="Professional oracle readings and astrology-inspired fashion. Discover your cosmic signature.">
  <meta property="og:image" content="https://lyrionatelier.com/images/logo/logo.png">
  <meta property="og:url" content="https://lyrionatelier.com">
  <meta name="twitter:card" content="summary_large_image">
  <title>Checkout | LyrÄ«on Atelier</title>
  <link rel="icon" type="image/png" href="images/favicon/favicon.png">
  <link rel="stylesheet" href="css/style.css">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX');
  </script>
</head>
<body>
  <a class="skip-to-content" href="#main-content">Skip to main content</a>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="index.html">
        <img class="brand-logo" src="images/logo/GOD.PNG" alt="LyrÄ«on Atelier logo">
        <span class="brand-name">LyrÄ«on Atelier</span>
      </a>
      <nav aria-label="Main navigation">
        <ul class="nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="shop.html">Shop</a></li>
          <li><a href="oracle.html">Oracle</a></li>
          <li><a href="codex.html">Codex</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
      <div class="header-actions">
        <a class="cart-icon" href="cart.html" aria-label="Shopping cart">ðŸ›’ <span class="cart-count">0</span></a>
        <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
      </div>
    </div>
  </header>

  <main id="main-content" class="section">
    <div class="container">
        <div class="section-title">
          <p class="pill">Secure checkout</p>
          <h1>Ready to send to the stars</h1>
          <p class="muted">Payments are securely processed by Stripe.</p>
        </div>

      <div class="card two-column-grid">
        <form id="checkout-form" data-validate="true">
          <div class="form-group">
            <label for="full-name">Full name</label>
            <input id="full-name" name="full-name" type="text" required minlength="2" placeholder="Aurora Vega">
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" placeholder="+1 (555) 555-5555">
          </div>
          <div class="form-group">
            <label for="address">Shipping address</label>
            <textarea id="address" name="address" rows="3" required placeholder="123 Cosmic Way, Celestial City"></textarea>
          </div>
          <div class="form-group">
            <label for="payment-element">Payment</label>
            <div id="payment-element" class="payment-element"></div>
            <p class="muted payment-helper-text">Card details are securely encrypted by Stripe.</p>
          </div>
          <div id="payment-message" class="payment-message" role="alert" aria-live="polite"></div>
          <button class="btn btn-primary" type="submit" id="pay-now-button">Pay now</button>
        </form>

        <div class="cart-summary">
          <h3>Order summary</h3>
          <p class="muted">Totals match your cart.</p>
          <div class="price-row"><span>Subtotal</span><strong id="cart-subtotal">$0.00</strong></div>
          <div class="price-row"><span>Shipping</span><strong id="cart-shipping">$0.00</strong></div>
          <div class="price-row"><span>Total</span><strong id="cart-total">$0.00</strong></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-inner">
      <div><strong class="brand-name">LyrÄ«on Atelier</strong></div>
      <div class="muted"><a href="cart.html">Review cart</a></div>
    </div>
  </footer>

  <script src="js/products.js" defer></script>
  <script src="js/cart.js" defer></script>
  <script src="js/main.js" defer></script>
  <script src="js/shipping-config.js"></script>
  <script>
    const getCart = () => JSON.parse(localStorage.getItem('cart')) || [];
    const SHIPPING_THRESHOLD = (window.shippingConfig && window.shippingConfig.SHIPPING_THRESHOLD) || 50;
    const SHIPPING_COST = (window.shippingConfig && window.shippingConfig.SHIPPING_COST) || 5.99;
    const STRIPE_JS_URL = 'https://js.stripe.com/v3/';
    const PAYMENT_INTENT_ENDPOINT = '/.netlify/functions/create-payment-intent';

    function calculateTotals(cart) {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const shipping = subtotal > SHIPPING_THRESHOLD ? 0 : (cart.length ? SHIPPING_COST : 0);
      const total = subtotal + shipping;
      return { subtotal, shipping, total };
    }

    function refreshSummary() {
      const cart = getCart();
      const { subtotal, shipping, total } = calculateTotals(cart);
      document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('cart-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
      document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
      return { cart, totals: { subtotal, shipping, total } };
    }

    const stripeState = {
      stripe: null,
      elements: null,
      paymentElement: null,
      clientSecret: null,
      initializing: false,
      initializingPromise: null,
      paymentElementMounted: false,
      stripeJsPromise: null,
    };

    const allowedReturnOrigins = (window.shippingConfig && window.shippingConfig.ALLOWED_ORIGINS) || ['https://lyrionatelier.com', 'https://www.lyrionatelier.com'];

    function resolveReturnUrlBase() {
      const origin = window.location.origin || '';
      if (allowedReturnOrigins.includes(origin)) return origin;
      if (origin.endsWith('.netlify.app')) return origin;
      if (origin.startsWith('http://localhost:')) return origin;
      return allowedReturnOrigins[0];
    }

    function setPaymentMessage(message, type = 'info') {
      const messageEl = document.getElementById('payment-message');
      if (!messageEl) return;
      messageEl.textContent = message;
      const baseClass = 'payment-message';
      if (type === 'error') {
        messageEl.className = `${baseClass} error`;
      } else if (type === 'success') {
        messageEl.className = `${baseClass} success`;
      } else {
        messageEl.className = baseClass;
      }
    }

    function setLoading(isLoading) {
      const payButton = document.getElementById('pay-now-button');
      if (!payButton) return;
      payButton.disabled = isLoading;
      payButton.textContent = isLoading ? 'Processing...' : 'Pay now';
    }

    function unmountPaymentElement() {
      if (stripeState.paymentElement) {
        stripeState.paymentElement.unmount();
        stripeState.paymentElement = null;
        stripeState.paymentElementMounted = false;
      }
    }

    function ensureStripeJsLoaded() {
      if (window.Stripe) return Promise.resolve(window.Stripe);
      if (stripeState.stripeJsPromise) return stripeState.stripeJsPromise;

      stripeState.stripeJsPromise = new Promise((resolve, reject) => {
        const existingScript = document.querySelector(`script[src="${STRIPE_JS_URL}"]`);
        let scriptElement = existingScript || document.createElement('script');
        const handleLoad = () => {
          if (window.Stripe) {
            resolve(window.Stripe);
          } else {
            reject(new Error('Stripe.js failed to load.'));
          }
        };

        if (existingScript) {
          if (window.Stripe) {
            resolve(window.Stripe);
            return;
          }
          const isLoaded = existingScript.readyState === 'complete' || existingScript.readyState === 'loaded';
          if (!isLoaded) {
            existingScript.addEventListener('load', handleLoad, { once: true });
            existingScript.addEventListener('error', () => reject(new Error('Stripe.js failed to load.')), { once: true });
            return;
          }
          existingScript.remove();
          scriptElement = document.createElement('script');
        }

        scriptElement.src = STRIPE_JS_URL;
        scriptElement.async = true;
        scriptElement.addEventListener('load', handleLoad, { once: true });
        scriptElement.addEventListener('error', () => reject(new Error('Stripe.js failed to load.')), { once: true });
        document.head.appendChild(scriptElement);
      });

      return stripeState.stripeJsPromise;
    }

    function getFormData() {
      return {
        name: document.getElementById('full-name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
      };
    }

    function getClientSecretFromUrl() {
      const params = new URLSearchParams(window.location.search || '');
      return params.get('payment_intent_client_secret');
    }

    async function updatePaymentStatus(stripe, clientSecret) {
      if (!stripe || !clientSecret) return;
      try {
        const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);
        if (!paymentIntent) return;
        if (paymentIntent.status === 'succeeded') {
          setPaymentMessage('Payment confirmed. Thank you for your order.', 'success');
        } else if (paymentIntent.status === 'processing') {
          setPaymentMessage('Your payment is processing. You will be notified once it completes.');
        } else if (paymentIntent.status === 'requires_payment_method') {
          setPaymentMessage('Your payment was not successful, please try again.', 'error');
        }
      } catch (statusError) {
        console.error('Could not retrieve payment status', statusError);
      }
    }

    async function initializeStripeElements() {
      const cart = getCart();
      if (!cart.length) {
        setPaymentMessage('Your cart is empty.');
        const payButton = document.getElementById('pay-now-button');
        if (payButton) payButton.disabled = true;
        return Promise.resolve(false);
      }

      if (stripeState.initializingPromise) {
        return stripeState.initializingPromise;
      }

      stripeState.initializing = true;
      stripeState.initializingPromise = (async () => {
        setLoading(true);
        const urlClientSecret = getClientSecretFromUrl();
        try {
          const response = await fetch(PAYMENT_INTENT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items: cart,
              currency: 'usd',
              customer: getFormData(),
              clientSecret: urlClientSecret || undefined,
            }),
          });

          const data = await response.json().catch(() => null);

          if (!response.ok || !data) {
            const serverMessage = data && data.error ? data.error : 'Unable to start payment.';
            throw new Error(serverMessage);
          }

          const clientSecret = data.clientSecret || urlClientSecret;
          if (!data.publishableKey || !clientSecret) {
            throw new Error('Missing payment configuration.');
          }

          await ensureStripeJsLoaded();
          let stripeInstance;
          try {
            stripeInstance = window.Stripe(data.publishableKey);
          } catch (stripeError) {
            throw new Error(`Stripe initialization failed: ${stripeError && stripeError.message ? stripeError.message : stripeError}`);
          }
          stripeState.stripe = stripeInstance;

          unmountPaymentElement();

          stripeState.clientSecret = clientSecret;
          stripeState.elements = stripeState.stripe.elements({ clientSecret });
          stripeState.paymentElement = stripeState.elements.create('payment');
          stripeState.paymentElement.mount('#payment-element');
          stripeState.paymentElementMounted = true;
          setPaymentMessage('Enter your payment details to complete checkout.');
          if (clientSecret) {
            updatePaymentStatus(stripeState.stripe, clientSecret);
          }
          return true;
        } catch (error) {
          console.error('Payment initialization failed', error);
          setPaymentMessage(error.message || 'Unable to start payment. Please try again.', 'error');
          return false;
        } finally {
          stripeState.initializing = false;
          setLoading(false);
          stripeState.initializingPromise = null;
        }
      })();

      return stripeState.initializingPromise;
    }

    const processStripePayment = async (event) => {
      event.preventDefault();
      const cart = getCart();
      if (!cart.length) {
        setPaymentMessage('Your cart is empty.', 'error');
        return;
      }

      setLoading(true);

      if (!stripeState.paymentElement || !stripeState.clientSecret) {
        const initialized = await initializeStripeElements();
        if (!initialized) {
          setPaymentMessage('Unable to start payment. Please try again.', 'error');
          setLoading(false);
          return;
        }
      }

      if (!stripeState.stripe || !stripeState.elements || !stripeState.paymentElement || !stripeState.clientSecret || !stripeState.paymentElementMounted) {
        setPaymentMessage('Payment setup incomplete. Refresh and try again.', 'error');
        setLoading(false);
        return;
      }

      setLoading(true);
      setPaymentMessage('Processing paymentâ€¦ Stripe confirmation required');
      const customer = getFormData();
      const returnUrlBase = resolveReturnUrlBase();

      const { error, paymentIntent } = await stripeState.stripe.confirmPayment({
        elements: stripeState.elements,
        confirmParams: {
          return_url: `${returnUrlBase}/checkout.html`,
          payment_method_data: {
            billing_details: {
              name: customer.name || undefined,
              email: customer.email || undefined,
              phone: customer.phone || undefined,
            },
          },
        },
        redirect: 'if_required',
      });

      if (error) {
        setPaymentMessage(error.message || 'Unable to confirm payment. Please check your details and try again.', 'error');
        setLoading(false);
        return;
      }

      const status = paymentIntent && paymentIntent.status;
      if (status === 'succeeded') {
        setPaymentMessage('Payment successful! Thank you.', 'success');
      } else if (status === 'processing') {
        setPaymentMessage('Your payment is processing. You will be notified once it completes.', 'info');
      } else {
        setPaymentMessage('Payment was not completed. Please try again with a different payment method.', 'error');
      }
      setLoading(false);
    };

    window.lyrionCheckout = window.lyrionCheckout || {};
    window.lyrionCheckout.processPayment = processStripePayment;

    document.addEventListener('DOMContentLoaded', () => {
      setPaymentMessage('Enter your payment details to complete checkout.');
      updateCartCount();
      refreshSummary();
      initializeStripeElements();
      const checkoutForm = document.getElementById('checkout-form');
      if (checkoutForm) {
        checkoutForm.addEventListener('submit', processStripePayment);
      }
    });
  </script>
</body>
</html>
