<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Lyrion Atelier - Celestial Guidance & Astrology">
  <meta property="og:description" content="Professional oracle readings and astrology-inspired fashion. Discover your cosmic signature.">
  <meta property="og:image" content="https://lyrionatelier.com/images/logo/logo.png">
  <meta property="og:url" content="https://lyrionatelier.com">
  <meta name="twitter:card" content="summary_large_image">
  <title>Checkout | LyrÄ«on Atelier</title>
  <link rel="icon" type="image/png" href="images/favicon/favicon.png">
  <link rel="stylesheet" href="css/style.css">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX');
  </script>
</head>
<body>
  <a class="skip-to-content" href="#main-content">Skip to main content</a>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="index.html">
        <img class="brand-logo" src="images/logo/GOD.PNG" alt="LyrÄ«on Atelier logo">
        <span class="brand-name">LyrÄ«on Atelier</span>
      </a>
      <nav aria-label="Main navigation">
        <ul class="nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="shop.html">Shop</a></li>
          <li><a href="oracle.html">Oracle</a></li>
          <li><a href="codex.html">Codex</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
      <div class="header-actions">
        <a class="cart-icon" href="cart.html" aria-label="Shopping cart">ðŸ›’ <span class="cart-count">0</span></a>
        <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">â˜°</button>
      </div>
    </div>
  </header>

  <main id="main-content" class="section">
    <div class="container">
      <div class="section-title">
        <p class="pill">Secure checkout</p>
        <h1>Ready to send to the stars</h1>
        <p class="muted">Enter your details and we'll confirm your order.</p>
      </div>

      <div class="card two-column-grid">
        <form id="checkout-form" data-validate="true">
          <div class="form-group">
            <label for="full-name">Full name</label>
            <input id="full-name" name="full-name" type="text" required minlength="2" placeholder="Aurora Vega">
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" placeholder="+1 (555) 555-5555">
          </div>
          <div class="form-group">
            <label for="address">Shipping address</label>
            <textarea id="address" name="address" rows="3" required placeholder="123 Cosmic Way, Celestial City"></textarea>
          </div>
          <div class="form-group">
            <label for="payment-element">Payment</label>
            <div id="payment-element" class="payment-element"></div>
            <p class="muted payment-helper-text">Card details are securely encrypted by Stripe.</p>
          </div>
          <div id="payment-message" class="payment-message" role="alert" aria-live="polite"></div>
          <button class="btn btn-primary" type="submit" id="pay-now-button">Pay now</button>
        </form>

        <div class="cart-summary">
          <h3>Order summary</h3>
          <p class="muted">Totals match your cart.</p>
          <div class="price-row"><span>Subtotal</span><strong id="cart-subtotal">$0.00</strong></div>
          <div class="price-row"><span>Shipping</span><strong id="cart-shipping">$0.00</strong></div>
          <div class="price-row"><span>Total</span><strong id="cart-total">$0.00</strong></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-inner">
      <div><strong class="brand-name">LyrÄ«on Atelier</strong></div>
      <div class="muted"><a href="cart.html">Review cart</a></div>
    </div>
  </footer>

  <script src="js/products.js" defer></script>
  <script src="js/cart.js" defer></script>
  <script src="js/main.js" defer></script>
  <script src="js/shipping-config.js"></script>
  <script src="https://js.stripe.com/v3"></script>
  <script>
    const getCart = () => JSON.parse(localStorage.getItem('cart')) || [];
    const SHIPPING_THRESHOLD = (window.shippingConfig && window.shippingConfig.SHIPPING_THRESHOLD) || 50;
    const SHIPPING_COST = (window.shippingConfig && window.shippingConfig.SHIPPING_COST) || 5.99;

    function calculateTotals(cart) {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const shipping = subtotal > SHIPPING_THRESHOLD ? 0 : (cart.length ? SHIPPING_COST : 0);
      const total = subtotal + shipping;
      return { subtotal, shipping, total };
    }

    function refreshSummary() {
      const cart = getCart();
      const { subtotal, shipping, total } = calculateTotals(cart);
      document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('cart-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
      document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
      return { cart, totals: { subtotal, shipping, total } };
    }

    const stripeState = {
      stripe: null,
      elements: null,
      paymentElement: null,
      clientSecret: null,
      initializing: false,
      initializingPromise: null,
    };

    const allowedReturnOrigins = (window.shippingConfig && window.shippingConfig.ALLOWED_ORIGINS) || ['https://lyrionatelier.com', 'https://www.lyrionatelier.com'];

    function resolveReturnUrlBase() {
      const origin = window.location.origin || '';
      if (allowedReturnOrigins.includes(origin)) return origin;
      if (origin.endsWith('.netlify.app')) return origin;
      if (origin.startsWith('http://localhost:')) return origin;
      return allowedReturnOrigins[0];
    }

    function setPaymentMessage(message, type = 'info') {
      const messageEl = document.getElementById('payment-message');
      if (!messageEl) return;
      messageEl.textContent = message;
      messageEl.className = type === 'error' ? 'payment-message error' : 'payment-message';
    }

    function setLoading(isLoading) {
      const payButton = document.getElementById('pay-now-button');
      if (!payButton) return;
      payButton.disabled = isLoading;
      payButton.textContent = isLoading ? 'Processing...' : 'Pay now';
    }

    function unmountPaymentElement() {
      if (stripeState.paymentElement) {
        stripeState.paymentElement.unmount();
        stripeState.paymentElement = null;
      }
    }

    function getFormData() {
      return {
        name: document.getElementById('full-name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
      };
    }

    async function initializeStripeElements() {
      const cart = getCart();
      if (!cart.length) {
        setPaymentMessage('Your cart is empty.');
        const payButton = document.getElementById('pay-now-button');
        if (payButton) payButton.disabled = true;
        return Promise.resolve(false);
      }

      if (stripeState.initializingPromise) {
        return stripeState.initializingPromise;
      }

      stripeState.initializing = true;
      stripeState.initializingPromise = (async () => {
        setLoading(true);
        try {
          const response = await fetch('/.netlify/functions/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items: cart,
              currency: 'usd',
            }),
          });

          if (!response.ok) {
            throw new Error('Unable to start payment.');
          }

          const data = await response.json();

          if (!stripeState.stripe) {
            stripeState.stripe = Stripe(data.publishableKey);
          }

          unmountPaymentElement();

          stripeState.clientSecret = data.clientSecret;
          stripeState.elements = stripeState.stripe.elements({ clientSecret: data.clientSecret });
          stripeState.paymentElement = stripeState.elements.create('payment');
          stripeState.paymentElement.mount('#payment-element');
          setPaymentMessage('');
          return true;
        } catch (error) {
          console.error('Payment initialization failed', error);
          setPaymentMessage('Payment setup failed. Please refresh and try again.', 'error');
          return false;
        } finally {
          stripeState.initializing = false;
          setLoading(false);
          stripeState.initializingPromise = null;
        }
      })();

      return stripeState.initializingPromise;
    }

    const processStripePayment = async (event) => {
      event.preventDefault();
      const cart = getCart();
      if (!cart.length) {
        setPaymentMessage('Your cart is empty.', 'error');
        return;
      }

      setLoading(true);

      if (!stripeState.paymentElement || !stripeState.clientSecret) {
        const initialized = await initializeStripeElements();
        if (!initialized) {
          setPaymentMessage('Payment is not ready. Please try again.', 'error');
          setLoading(false);
          return;
        }
      }

      if (!stripeState.stripe || !stripeState.elements || !stripeState.paymentElement || !stripeState.clientSecret) {
        setPaymentMessage('Payment is not ready. Please try again.', 'error');
        setLoading(false);
        return;
      }

      setLoading(true);
      setPaymentMessage('');
      const customer = getFormData();
      const returnUrlBase = resolveReturnUrlBase();

      const { error } = await stripeState.stripe.confirmPayment({
        elements: stripeState.elements,
        confirmParams: {
          return_url: `${returnUrlBase}/success.html`,
          payment_method_data: {
            billing_details: {
              name: customer.name || undefined,
              email: customer.email || undefined,
              phone: customer.phone || undefined,
            },
          },
        },
      });

      if (error) {
        setPaymentMessage(error.message || 'Payment failed. Please try again.', 'error');
        setLoading(false);
      }
    };

    window.lyrionCheckout = window.lyrionCheckout || {};
    window.lyrionCheckout.processPayment = processStripePayment;

    document.addEventListener('DOMContentLoaded', () => {
      updateCartCount();
      refreshSummary();
      initializeStripeElements();
      const checkoutForm = document.getElementById('checkout-form');
      if (checkoutForm) {
        checkoutForm.addEventListener('submit', processStripePayment);
      }
    });
  </script>
</body>
</html>
